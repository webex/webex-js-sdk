import '@webex/internal-plugin-devices';

import {assert} from '@webex/test-helper-chai';
import sinon from 'sinon';
import WebexCore from '@webex/webex-core';
import testUsers from '@webex/test-helper-test-users';

describe('plugin-devices', () => {
  describe('Webex', () => {
    let devices;
    let user;
    let webex;

    before('create users', () => testUsers.create({count: 1})
      .then(([createdUser]) => {
        user = createdUser;
      }));

    beforeEach('create webex instance', () => {
      webex = new WebexCore({
        credentials: user.token
      });

      devices = webex.internal.devices;

      return devices.register();
    });

    describe('#onBeforeLogout()', () => {
      beforeEach('setup spy', () => {
        sinon.spy(devices, 'unregister');
      });

      it('unregisters the device', () =>
        webex.logout({noRedirect: true})
          .then(() => {
            assert.called(devices.unregister);
            assert.isFalse(devices.registered);
          }));
    });
  });
});
