/*!
 * Copyright (c) 2015-2019 Cisco Systems, Inc. See LICENSE file.
 */

import makeLocalUrl from '@webex/test-helper-make-local-url';
import {assert} from '@webex/test-helper-chai';
import {defaults, HttpStatusInterceptor} from '@webex/http-core';
import MockWebex from '@webex/test-helper-mock-webex';
import Device, {EmbargoInterceptor} from '@webex/internal-plugin-wdm';
import deviceFixture from '../../lib/device-fixture';
import sinon from '@webex/test-helper-sinon';

describe('plugin-wdm', function () {
  // This isn't quite a unit test since we hit the local fixture server;
  // sometimes, sauce makes the fixture server a bit slow.
  this.timeout(30000);
  describe('EmbargoInterceptor', () => {
    let webex;

    beforeEach(() => {
      webex = new MockWebex({
        children: {
          device: Device
        }
      });

      webex.request = defaults({
        interceptors: [
          new EmbargoInterceptor({webex}),
          HttpStatusInterceptor.create()
        ]
      });

      sinon.spy(webex.internal.device, 'clear');
      webex.credentials.clear = sinon.spy();
      webex.internal.device.set(deviceFixture);

      webex.internal.device.services = {};
      webex.internal.device.config.preDiscoveryServices = {};
    });

    describe('when it receives a 451', () => {
      it('bricks the client', () => assert.isRejected(webex.request({uri: makeLocalUrl('/embargoed')}))
        .then((reason) => {
          assert.statusCode(reason, 451);
          assert.calledOnce(webex.internal.device.clear);
        }));
    });
  });
});
