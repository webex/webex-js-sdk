import chai from 'chai';
import chaiAsPromised from 'chai-as-promised';
import sinon from 'sinon';

import StatsAnalyzer from '../../../../src/statsAnalyzer';

const {assert} = chai;

chai.use(chaiAsPromised);
sinon.assert.expose(chai.assert, {prefix: ''});

describe('plugin-meetings', () => {
  describe('StatsAnalyzer', () => {
    describe('compareSentAndReceived()', () => {
      let statsAnalyzer;

      const initialConfig = {
        videoPacketLossRatioThreshold: 9
      };

      const defaultStats = {
        internal: {
          video: {
            send: {
              totalPacketsLostOnReceiver: 10
            }
          }
        },
        video: {
          send: {
            packetsSent: 2
          }
        }
      };

      const statusResult = {
        type: 'remote-outbound-rtp',
        packetsLost: 11
      };

      const sandbox = sinon.createSandbox();

      beforeEach(() => {
        statsAnalyzer = new StatsAnalyzer(initialConfig, defaultStats);
        sandbox.spy(statsAnalyzer, 'emit');
      });

      afterEach(() => {
        sandbox.restore();
      });

      it('should trigger downgrade video callback because packet loss is high', async () => {
        await statsAnalyzer.parseGetStatsResult(statusResult, 'video');

        assert.calledOnce(statsAnalyzer.emit);
      });

      it('should not trigger downgrade video callback', async () => {
        await statsAnalyzer.parseGetStatsResult({
          ...statusResult,
          packetsLost: 0
        }, 'video');

        assert.notCalled(statsAnalyzer.emit);
      });
    });
  });
});
