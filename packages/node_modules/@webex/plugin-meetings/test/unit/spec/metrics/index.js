/*!
 * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.
 */
/* globals window */
import sinon from 'sinon';
import Metrics from '@webex/internal-plugin-metrics';
import metrics from '@webex/plugin-meetings/src/metrics';
import BrowserDetection from '@webex/plugin-meetings/src/common/browser-detection';
import MockWebex from '@webex/test-helper-mock-webex';
import {browserOnly} from '@webex/test-helper-mocha';
import {assert} from '@webex/test-helper-chai';

const {
  getBrowserName,
  getBrowserVersion,
  getOSName,
  getOSVersion
} = BrowserDetection();

/**
 * Meeting can only run in a browser, so we can only send metrics for
 * browser usage.
 */
browserOnly(describe)('Meeting metrics', () => {
  let webex, mockSubmitMetric, sandbox;

  beforeEach(() => {
    sandbox = sinon.createSandbox();
    mockSubmitMetric = sandbox.stub();
    webex = new MockWebex({
      children: {
        metrics: Metrics
      }
    });

    webex.version = '1.2.3';
    webex.credentials.getOrgId = sinon.fake.returns('7890');
    webex.credentials.config = {
      _values: {
        clientId: 'mock-client-id'
      }
    };

    webex.internal.metrics.submitClientMetrics = mockSubmitMetric;
    metrics.initialSetup({}, webex);
  });

  afterEach(() => {
    sandbox.restore();
  });

  describe('#sendOperationalMetric', () => {
    it('sends client metric via Metrics plugin', () => {
      metrics.sendOperationalMetric('myMetric');

      assert.calledOnce(mockSubmitMetric);
    });

    it('adds environment information to metric', () => {
      const data = {value: 567};
      const metadata = {test: true};

      metrics.sendOperationalMetric('myMetric', data, metadata);

      assert.calledWithMatch(
        mockSubmitMetric,
        'myMetric',
        {
          type: ['operational'],
          fields: {
            browser_version: getBrowserVersion(),
            os_version: getOSVersion(),
            sdk_version: '1.2.3',
            value: 567
          },
          tags: {
            org_id: '7890',
            os: getOSName(),
            browser: getBrowserName(),
            domain: window.location.hostname,
            test: true
          }
        }
      );
    });

    it('throws error if no metric name is given', () => {
      assert.throws(
        () => metrics.sendOperationalMetric(),
        'Missing operational metric name. Please provide one'
      );
    });
  });
});
