import {StatelessSparkPlugin} from '@ciscospark/spark-core';

import {MEETINGS, _PERSONAL_ROOM_} from '../constants';
import MeetingInfoRequest from '../meeting-info/request';

import PersonalMeetingRoomRequest from './request';

/**
 * @class PersonalMeetingRoom
 */
export default class PersonalMeetingRoom extends StatelessSparkPlugin {
  namespace = MEETINGS;

  /**
   *
   * @param {Object} attrs
   * @param {Object} options
   */
  constructor(attrs, options) {
    super({}, options);
    this.pmr = null;
    this.sipUri = null;
    this.link = null;
    this.userId = null;
    this.name = null;
    this.meetingInfoRequest = new MeetingInfoRequest({}, options);
    this.personalMeetingRoomRequest = new PersonalMeetingRoomRequest({}, options);
  }

  /**
   * claims a pmr and updates the cached PMR values
   * @param {String} link
   * @param {String} pin
   * @param {Boolean} preferred optional, defaults to true to set this claimed PMR as the preferred
   * @returns {Promise}
   * @memberof PersonalMeetingRoom
   */
  claim(link, pin, preferred = true) {
    const options = {
      userId: this.spark.internal.device.userId,
      passcode: pin,
      meetingAddress: link,
      preferred
    };
    return this.personalMeetingRoomRequest.claimPmr(options).then((pmr) => {
      if (pmr && pmr.body) {
        this.set(pmr.body);
      }
      else {
        return Promise.reject(new Error('No PMR body provided. PMR values not updated.'));
      }
      return pmr.body;
    });
  }

  /**
   * @param {Object} body the response body from meeting info request
   * @returns {undefined}
   * @memberof PersonalMeetingRoom
   */
  set(body) {
    this.pmr = body;
    this.sipUri = body.sipMeetingUri;
    this.meetingLink = body.webExMeetingLink || body.meetingLink;
    this.userId = body.owner;
    this.name = body.meetingName;
    this.number = body.meetingNumber;
  }

  /**
   * TODO: implement TTL for syncing and caching so to not request again and again
   * @param {Object} options
   * @returns {Promise}
   * @memberof PersonalMeetingRoom
   */
  get() {
    const options = {
      type: _PERSONAL_ROOM_,
      destination: this.spark.internal.device.userId
    };
    return this.meetingInfoRequest.fetchMeetingInfo(options).then((pmr) => {
      if (pmr && pmr.body && pmr.body.isPmr) {
        this.set(pmr.body);
      }
      else {
        return Promise.reject(new Error('The PMR requested is NOT a PMR. PMR values not set.'));
      }
      return pmr.body;
    });
  }
}
