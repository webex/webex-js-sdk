/* eslint-env browser */

/* global spark */

/* eslint-disable camelcase */
/* eslint-disable max-nested-callbacks */
/* eslint-disable no-alert */
/* eslint-disable no-console */
/* eslint-disable require-jsdoc */

function requestPinChallenge(deviceId) {
  return spark.devicemanager.requestPin({id: deviceId})
    .then(() => {
      toggleDisplay('enterPinDiv', true);
      toggleDisplay('requestPairingBtnDiv', true);
      notify('Enter the PIN');
    });
}


document.getElementById('deviceControls').refresh.addEventListener('click', () => {
  if (spark.devicemanager) {
    notify('Listing devices...');
    return spark.devicemanager.refresh()
      .then((devices) => {
        populateDeviceDropdown(devices);
        notify('');
        toggleDisplay('requestPinDiv', true);
        toggleDisplay('removeBtnDiv', true);
      });
  }
  return false;
});

// when PIN is requested
document.getElementById('requestPin').addEventListener('click', () => {
  if (spark.devicemanager) {
    notify('Requesting Pin...');
    const dropdown = document.getElementById('device-list-dropdown');
    const deviceId = dropdown.options[dropdown.selectedIndex].value;
    if (deviceId && deviceId !== 'Choose a Device') {
      return requestPinChallenge(deviceId);
    }
    notify('Select a device first');
  }
  return false;
});

// when device pairing is requested
document.getElementById('requestPairing').addEventListener('click', () => {
  if (spark.devicemanager) {
    notify('Pairing...');
    const pin = document.getElementById('pin').value;
    return spark.devicemanager.pair({pin})
      .then(() => {
        notify('Paired');
        toggleDisplay('requestUnPairingBtnDiv', true);
        toggleDisplay('getAudioStateBtnDiv', true);
        toggleDisplay('volumeUpBtnDiv', true);
        toggleDisplay('volumeDownBtnDiv', true);
        toggleDisplay('muteBtnDiv', true);
        toggleDisplay('wirelessShare', true);
        // toggleDisplay('stopWirelessShare', true);
        toggleDisplay('enterConvoIdDiv', true);
        toggleDisplay('bindSpaceBtnDiv', true);
      })
      .then(() => spark.devicemanager.refresh())
      .then((devices) => {
        populateDeviceDropdown(devices);
        notify('');
        toggleDisplay('requestPinDiv', true);
        toggleDisplay('removeBtnDiv', true);
      })
      .catch(() => {
        notify('Incorrect PIN');
      });
  }
  return false;
});

// when device unpairing is requested
document.getElementById('requestUnPairing').addEventListener('click', () => {
  if (spark.devicemanager) {
    notify('UnPairing...');
    return spark.devicemanager.unpair()
      .then(() => {
        notify('UnPaired');
        toggleDisplay('requestUnPairingBtnDiv', false);
        toggleDisplay('requestPairingBtnDiv', false);
        toggleDisplay('enterPinDiv', false);
        toggleDisplay('getAudioStateBtnDiv', false);
        toggleDisplay('hideAudioStateBtnDiv', false);
        toggleDisplay('getAudioStateContentsDiv', false);
        toggleDisplay('volumeUpBtnDiv', false);
        toggleDisplay('volumeDownBtnDiv', false);
        toggleDisplay('muteBtnDiv', false);
        toggleDisplay('unmuteBtnDiv', false);
        toggleDisplay('wirelessShare', false);
        toggleDisplay('stopWirelessShare', false);
        toggleDisplay('enterConvoIdDiv', false);
        toggleDisplay('bindSpaceBtnDiv', false);
        toggleDisplay('unbindSpaceBtnDiv', false);
      });
  }
  return false;
});

// getAudioState of the paired device
document.getElementById('getAudioState').addEventListener('click', () => {
  if (spark.devicemanager) {
    notify('GettingAudioState...');
    return spark.devicemanager.getAudioState()
      .then((res) => {
        populateDeviceAudioState(res);
        notify('Audio State fetched');
      });
  }
  return false;
});

// increase volume of paired device
document.getElementById('volumeUp').addEventListener('click', () => {
  if (spark.devicemanager) {
    notify('Increasing Volume...');
    return spark.devicemanager.increaseVolume()
      .then(() => spark.devicemanager.getAudioState())
      .then((res) => {
        populateDeviceAudioState(res);
        notify('Volume Increased');
      });
  }
  return false;
});

// increase volume of paired device
document.getElementById('volumeDown').addEventListener('click', () => {
  if (spark.devicemanager) {
    notify('Decreasing Volume...');
    return spark.devicemanager.decreaseVolume()
      .then(() => spark.devicemanager.getAudioState())
      .then((res) => {
        populateDeviceAudioState(res);
        notify('Volume Decreased');
      });
  }
  return false;
});

// mute paired device
document.getElementById('mute').addEventListener('click', () => {
  if (spark.devicemanager) {
    notify('Muting...');
    return spark.devicemanager.mute()
      .then(() => spark.devicemanager.getAudioState())
      .then((res) => {
        populateDeviceAudioState(res);
        notify('Muted');
        toggleDisplay('muteBtnDiv', false);
        toggleDisplay('unmuteBtnDiv', true);
      });
  }
  return false;
});

// unmute paired device
document.getElementById('unmute').addEventListener('click', () => {
  if (spark.devicemanager) {
    notify('UnMuting');
    return spark.devicemanager.unmute()
      .then(() => spark.devicemanager.getAudioState())
      .then((res) => {
        populateDeviceAudioState(res);
        notify('Unmuted');
        toggleDisplay('muteBtnDiv', true);
        toggleDisplay('unmuteBtnDiv', false);
      });
  }
  return false;
});

// // when bindSpace is requested
// document.getElementById('bindSpace').addEventListener('click', () => {
//   if (spark.devicemanager) {
//     notify('Binding space...');
//     const convoId = document.getElementById('convoId').value;
//     const url = `${spark.internal.device.services.conversationServiceUrl}/conversations/${convoId}`;
//     return spark.internal.conversation.get({url}, {
//       url,
//       includeUxTimers: true,
//       ackFilter: 'noack',
//       includeParticipants: false,
//       lastViewableActivityOnly: true,
//       participantsLimit: 0
//     })
//       .then((conversation) => spark.devicemanager.bindSpace({
//         url,
//         kmsResourceObjectUrl: conversation.kmsResourceObjectUrl
//       }))
//       .then(() => {
//         notify('Space is bound');
//         toggleDisplay('bindSpaceBtnDiv', false);
//         toggleDisplay('unbindSpaceBtnDiv', true);
//       })
//       .catch(() => {
//         notify('Space could not be bound');
//       });
//   }
//   return false;
// });

// // when unbindSpace is requested
// document.getElementById('unbindSpace').addEventListener('click', () => {
//   if (spark.devicemanager) {
//     notify('UnBinding space...');
//     return spark.devicemanager.unbindSpace()
//       .then(() => {
//         notify('Space is unbound');
//         toggleDisplay('bindSpaceBtnDiv', true);
//         toggleDisplay('unbindSpaceBtnDiv', false);
//       })
//       .catch(() => {
//         notify('Space could not be bound');
//       });
//   }
//   return false;
// });

document.getElementById('remove').addEventListener('click', () => {
  if (spark.devicemanager) {
    notify('Removing selected device...');
    const dropdown = document.getElementById('device-list-dropdown');
    const deviceId = dropdown.options[dropdown.selectedIndex].value;
    if (deviceId && deviceId !== 'Choose a Device') {
      return spark.devicemanager.remove(deviceId)
        .then(() => {
          notify('Device removed');
          return spark.devicemanager.refresh();
        })
        .then((devices) => {
          populateDeviceDropdown(devices);
          toggleDisplay('requestPinDiv', true);
          toggleDisplay('removeBtnDiv', true);
        })
        .catch(() => {
          notify('Failed to remove the device');
        });
    }
    notify('Select a device first');
  }
  return false;
});

document.getElementById('search').addEventListener('click', () => {
  if (spark.devicemanager) {
    const searchQuery = document.getElementById('searchQuery').value;
    if (searchQuery && searchQuery.length >= 3) {
      return spark.devicemanager.search({
        searchQuery
      })
        .then((res) => {
          populateDeviceSearchResults(res);
        })
        .catch((error) => {
          console.error(error);
        });
    }
    console.info('Requires atleast 3 chars to search');
  }
  return false;
});

function notify(message) {
  document.getElementById('notifications').innerHTML = message;
  setTimeout(() => {
    document.getElementById('notifications').innerHTML = '';
  }, 5000);
}

function populateDeviceDropdown(devices) {
  const deviceListDropdown = document.getElementById('device-list-dropdown');
  deviceListDropdown.length = 0;

  const defaultOption = document.createElement('option');
  defaultOption.text = 'Choose a Device';
  deviceListDropdown.add(defaultOption);
  deviceListDropdown.selectedIndex = 0;

  let option;
  devices.forEach((device) => {
    option = document.createElement('option');
    option.text = device.deviceInfo.description || device.deviceInfo.name;
    option.value = device.id;
    deviceListDropdown.add(option);
  });
}

function populateDeviceAudioState(audioState) {
  document.getElementById('getAudioStateContentsDiv').innerHTML = `<div>
    <ul>
      <li>Muted: ${audioState.microphones.muted}</li>
      <li>volume current level: ${audioState.volume.level}</li>
      <li>volume max level: ${audioState.volume.max}</li>
      <li>volume min level: ${audioState.volume.min}</li>
      <li>volume step level: ${audioState.volume.step}</li>
    </ul>
    <div id='hideAudioStateBtnDiv' style=muted"display:none;">
      <button id="hideAudioState" title="hideAudioState" type="button">hideAudioState</button>
    </div>
  </div>`;
  toggleDisplay('getAudioStateContentsDiv', true);
  toggleDisplay('hideAudioStateBtnDiv', true);
  // hideAudioState of the paired device
  document.getElementById('hideAudioState').addEventListener('click', () => {
    toggleDisplay('getAudioStateContentsDiv', false);
    toggleDisplay('hideAudioStateBtnDiv', false);
  });
}

function populateDeviceSearchResults(response) {
  let devices = '';
  response.forEach((device) => {
    devices += `
      <li style='list-style-type: none'>
        <input type='radio' name='deviceRadio' onclick='requestPinChallenge("${device.id}")'/>
        <label>${device.description || device.name}</label>
      </li>`;
  });
  document.getElementById('getDeviceSearchResultsDiv').innerHTML = `<div>
    <ul>
      ${devices}
    </ul>
    <div id='hideDeviceSearchResultsBtnDiv' style=muted"display:none;">
      <button id="hideDeviceSearchResults" title="hideDeviceSearchResults" type="button">hideDeviceSearchResults</button>
    </div>
  </div>`;
  toggleDisplay('getDeviceSearchResultsDiv', true);
  toggleDisplay('hideDeviceSearchResults', true);
  // hideAudioState of the paired device
  document.getElementById('hideDeviceSearchResults').addEventListener('click', () => {
    toggleDisplay('getDeviceSearchResultsDiv', false);
    toggleDisplay('hideDeviceSearchResults', false);
  });
}

document.getElementById('device').addEventListener('click', () => {
  const devices = document.getElementById('devices').style.display;
  if (devices === 'block') {
    toggleDisplay('devices', false);
  }
  else {
    toggleDisplay('devices', true);
  }
});

function toggleDisplay(elementId, status) {
  const element = document.getElementById(elementId);
  if (status) {
    element.style.display = 'block';
  }
  else {
    element.style.display = 'none';
  }
}
