// TODO join call, start screen share, end call
// TODO join call, start screen share, end screen share, start screen share, end call
// TODO join call, start screen share, end screen share, start app share, end call
// TODO join call, start screen share, start app share, end call

import testUsers from '@ciscospark/test-helper-test-users';
import setValue from '../lib/set-value';

describe(`sample-browser-single-party-screen-share`, () => {
  describe(`join call, start screen share, end call`, () => {
    let mccoy, spock;

    /**
     * @type {browser}
     */
    const browserSpock = browser.select(`browserSpock`);

    /**
     * @type {browser}
     */
    const browserMccoy = browser.select(`browserMccoy`);

    before(`create test users`, () => testUsers.create({count: 2})
      .then((users) => {
        spock = users[0];
        mccoy = users[1];
      }));

    step(`loads the app`, () => {
      browser.url(`/packages/node_modules/sample-browser-single-party-screen-share?usefakemedia`);
    });

    step(`connects mccoy's browser`, () => {
      browserMccoy.waitUntil(() => browserMccoy.getTitle() === `Sample: Screensharing`);
      browserMccoy.execute(setValue, `[placeholder="Your access token"]`, mccoy.token.access_token);
      browserMccoy.click(`[title="connect"]`);
      browserMccoy.waitForExist(`.listening`);
    });

    step(`connects spock's browser`, () => {
      browserSpock.waitUntil(() => browserSpock.getTitle() === `Sample: Screensharing`);
      browserSpock.execute(setValue, `[placeholder="Your access token"]`, spock.token.access_token);
      browserSpock.click(`[title="connect"]`);
      browserSpock.waitForExist(`.listening`);
    });

    step(`places call from spock to mccoy`, () => {
      browserSpock.setValue(`[placeholder="Person ID or Email Address or SIP Uri or Room ID"]`, mccoy.emailAddress);
      browserSpock.click(`[title="dial"]`);

      browserMccoy.waitUntil(() => {
        try {
          browserMccoy.alertAccept();
          return true;
        }
        catch (err) {
          return false;
        }
      });
    });

    step(`shares screen from spock to mccoy`, () => {
      browserSpock.click(`[title="share screen"]`);
      console.log(browserSpock.getAttribute(`#self-view`, `srcObject`));
      console.log(browserSpock.getAttribute(`#self-screen`, `srcObject`));
      browser.pause(5000);
      console.log(browserSpock.getAttribute(`#self-screen`, `srcObject`));
    });
  });
});
