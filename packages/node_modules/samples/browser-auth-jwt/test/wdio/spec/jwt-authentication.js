import {createUser} from '@ciscospark/test-helper-appid';
import uuid from 'uuid';
import {expect} from 'chai';

describe('samples', () => {
  describe('browser-auth-jwt', () => {
    describe('authenticate using jwt', () => {
      let spockJwt;

      before('creates spock jwt', () => createUser({displayName: `test-${uuid.v4()}`})
        .then(({jwt}) => {
          spockJwt = jwt;
        }));

      before('reload browser', () => {
        browser.browserSpock.refresh();
        browser.browserMccoy.refresh();
      });

      it('browses to sample app and verifies the user is not authenticated', () => {
        browser.url('/browser-auth-jwt');
        browser.waitForExist('[placeholder="JSON Web Token"]');

        expect(browser.select('browserSpock').getText('#authentication-status')).to.equal('Not Authenticated');
        expect(browser.select('browserMccoy').getText('#authentication-status')).to.equal('Not Authenticated');
      });

      describe('initiates jwt authentication', () => {
        before(() => browser.setValue('[placeholder="JSON Web Token"]', spockJwt));

        it('in Firefox', () => {
          const browserSpock = browser.select('browserSpock');

          browserSpock.click('[title="authenticate"]');

          browserSpock.pause(10000);

          browserSpock.waitUntil(
            () => browserSpock.getText('#authentication-status') === 'Authenticated',
            10000,
            'expected authentication status to be Authenticated in browserSpock'
          );

          expect(browserSpock.getText('#authentication-status')).to.equal('Authenticated');
        });

        it('in Chrome', () => {
          const browserMccoy = browser.select('browserMccoy');

          browserMccoy.click('[title="authenticate"]');

          browserMccoy.pause(10000);

          browserMccoy.waitUntil(
            () => browserMccoy.getText('#authentication-status') === 'Authenticated',
            10000,
            'expected authentication status to be Authenticated in browserMccoy'
          );

          expect(browserMccoy.getText('#authentication-status')).to.equal('Authenticated');
        });
      });
    });
  });
});
