/* eslint-disable no-warning-comments */

import '@ciscospark/plugin-phone';

import CiscoSpark from '@ciscospark/spark-core';
import testUsers from '@ciscospark/test-helper-test-users';
import setValue from '../lib/set-value';

describe(`sample-browser-multi-party-call`, () => {

  describe(`normal dialing`, () => {
    let mccoy, roomId, spock;

    const browserSpock = browser.select(`browserSpock`);
    const browserMccoy = browser.select(`browserMccoy`);

    before(`create test users`, () => testUsers.create({count: 2})
      .then((users) => {
        spock = users[0];
        mccoy = users[1];

        spock.spark = new CiscoSpark({
          credentials: {
            authorization: spock.token
          }
        });

        return spock.spark.phone.register();
      }));

    before(`create test room and add members to room`, () => spock.spark.request({
      method: `POST`,
      service: `hydra`,
      resource: `rooms`,
      body: {
        title: `Call Test`
      }
    })
      .then((res) => {
        const room = res.body;

        roomId = room.id;

        return spock.spark.request({
          method: `POST`,
          service: `hydra`,
          resource: `memberships`,
          body: {
            roomId: room.id,
            personId: mccoy.id
          }
        });
      })
      .then(() => spock.spark.phone.deregister()));

    step(`loads the app`, () => {
      browser.reload();
      browser.url(`/browser-multi-party-call/`);
    });

    step(`connects mccoy's browser`, () => {
      browserMccoy.waitUntil(() => browserMccoy.getTitle() === `Sample: Multi Party Calling`);
      browserMccoy.execute(setValue, `[placeholder="Your access token"]`, mccoy.token.access_token);
      // Debouncing before connecting reduces flakiness
      browserSpock.pause(500);
      browserMccoy.click(`[title="connect"]`);
      browserMccoy.waitForExist(`.listening`);
    });

    step(`connects spock's browser`, () => {
      browserSpock.waitUntil(() => browserSpock.getTitle() === `Sample: Multi Party Calling`);
      browserSpock.execute(setValue, `[placeholder="Your access token"]`, spock.token.access_token);
      browserSpock.click(`[title="connect"]`);
      browserSpock.waitForExist(`.listening`);
    });

    step(`places call from spock to mccoy`, () => {
      browserSpock.setValue(`[placeholder="Room ID or SIP Uri"]`, roomId);
      browserSpock.click(`[title="dial"]`);

      browserMccoy.waitUntil(() => {
        try {
          browserMccoy.alertAccept();
          return true;
        }
        catch (err) {
          return false;
        }
      });
    });

    step(`ends the call`, () => {
      browser.pause(5000);
      // TODO add assertions around streams

      browserSpock.click(`[title="hangup"]`);
      browserMccoy.click(`[title="hangup"]`);
    });
  });
});
