/* eslint-disable no-warning-comments */

import '@webex/internal-plugin-wdm';

import WebexCore from '@webex/webex-core';
import testUsers from '@webex/test-helper-test-users';
import {expect} from 'chai';

describe('sample', () => {
  describe('browser-multi-party-call', () => {
    describe('dial before connecting', () => {
      let mccoy, roomId, spock;

      const browserSpock = browser.select('browserSpock');
      const browserMccoy = browser.select('browserMccoy');

      before('reload browser', () => {
        browser.refresh();
      });

      before('create test users', () => testUsers.create({count: 2})
        .then((users) => {
          [spock, mccoy] = users;

          // Adding pause to let test users propagate through integration
          browser.pause(2500);

          spock.webex = new WebexCore({
            credentials: {
              authorization: spock.token
            }
          });

          return spock.webex.internal.device.register();
        }));

      before('create test room and add members to room', () => spock.webex.request({
        method: 'POST',
        service: 'hydra',
        resource: 'rooms',
        body: {
          title: 'Call Test'
        }
      })
        .then((res) => {
          const room = res.body;

          roomId = room.id;

          return spock.webex.request({
            method: 'POST',
            service: 'hydra',
            resource: 'memberships',
            body: {
              roomId: room.id,
              personId: mccoy.id
            }
          });
        })
        .then(() => spock.webex.internal.device.unregister()));

      it('loads the app', () => {
        browser.url('/browser-multi-party-call/');
      });

      it('connects spock\'s browser', () => {
        expect(browserSpock.getTitle()).to.equal('Sample: Multi Party Calling');
        browserSpock.execute((token) => {
          // eslint-disable-next-line no-undef
          document.querySelector('[placeholder="Your access token"]').value += token;
        }, spock.token.access_token);
        browserSpock.click('[title="connect"]');
        browserSpock.waitForExist('.listening');
      });

      it('places call from spock to shared room', () => {
        browserSpock.setValue('[placeholder="Room ID or SIP URI"]', roomId);
        browserSpock.click('[title="dial"]');
        browserSpock.waitForExist(`#member-status-${spock.id}`, 5000);
        browserSpock.waitUntil(() => (browserSpock.getText(`#member-status-${spock.id}`) === 'IN_MEETING'), 10000, `Timed-out waiting for local user (${spock.id}) to connect to meeting`);
      });

      it('connects mccoy\'s browser after call has started and answers', () => {
        expect(browserMccoy.getTitle()).to.equal('Sample: Multi Party Calling');
        browserMccoy.execute((token) => {
          // eslint-disable-next-line no-undef
          document.querySelector('[placeholder="Your access token"]').value += token;
        }, mccoy.token.access_token);
        browserMccoy.click('[title="connect"]');
        browserMccoy.waitUntil(() => {
          try {
            const alerttext = browserMccoy.alertText();

            return alerttext === 'Answer incoming call';
          }
          catch (error) {
            // Error is thrown when alert isn't open which is fine
            return false;
          }
        }, 10000, 'Timed out waiting for incoming call alert');
        browserMccoy.alertAccept();
      });

      it('ends the call', () => {
        browserSpock.waitUntil(() => (browserSpock.getText(`#member-status-${mccoy.id}`) === 'IN_MEETING'), 10000, 'Timed-out waiting for remote user to connect to meeting');
        browserSpock.click('[title="hangup"]');
        browserSpock.waitUntil(() => (browserSpock.getText(`#member-status-${spock.id}`) === 'NOT_IN_MEETING'), 10000, 'Timed-out waiting for local user to disconnect from meeting');
        browser.refresh();
      });
    });
  });
});
