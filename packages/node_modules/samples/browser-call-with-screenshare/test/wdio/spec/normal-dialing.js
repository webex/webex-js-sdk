import testUsers from '@webex/test-helper-test-users';
import {flaky} from '@webex/test-helper-mocha';
import {expect} from 'chai';

describe('samples', () => {
  describe('browser-call-with-screenshare', () => {
    describe('normal dialing', () => {
      let mccoy, spock;

      const browserFirefox = browser.select('browserFirefox');
      const browserChrome = browser.select('browserChrome');

      before('create test users', () => testUsers.create({count: 2})
        .then((users) => {
          [spock, mccoy] = users;
          // Adding pause to let test users propagate through integration
          browser.pause(2500);
        }));

      it('pauses and waits for h264 to download', () => {
        browser.refresh();
        browserChrome.pause(30000);
        browser.refresh();
        browserChrome.pause(30000);
        browser.refresh();
      });

      it('loads the app', () => {
        browser.url('/browser-call-with-screenshare');
        browser.waitForExist('#access-token', 1500);
      });

      it('connects mccoy\'s browser', () => {
        expect(browserChrome.getTitle()).to.equal('Sample: Local Screensharing');
        browserChrome.setValue('#access-token', mccoy.token.access_token);
        browserChrome.click('#connect');
        browserChrome.waitForExist('.listening');
      });

      it('connects spock\'s browser', () => {
        expect(browserFirefox.getTitle()).to.equal('Sample: Local Screensharing');
        browserFirefox.setValue('#access-token', spock.token.access_token);
        browserFirefox.click('#connect');
        browserFirefox.waitForExist('.listening');
      });

      it('places call from spock to mccoy', () => {
        browserFirefox.setValue('[placeholder="Person ID or Email Address or SIP URI or Room ID"]', mccoy.emailAddress);
        browserFirefox.click('[title="dial"]');

        browserFirefox.waitUntil(() => (browserFirefox.getText('#call-status-local') === 'IN_MEETING'), 10000, 'Timed-out waiting for local user to connect to meeting');
      });

      it('joins the call on mccoy', () => {
        browserChrome.waitUntil(() => {
          try {
            const alerttext = browserChrome.alertText();

            return alerttext === 'Answer incoming call';
          }
          catch (error) {
            // Error is thrown when alert isn't open which is fine
            return false;
          }
        }, 10000, 'Timed out waiting for incoming call alert');
        browserChrome.alertAccept();
        browserFirefox.waitUntil(() => (browserFirefox.getText('#call-status-remote') === 'IN_MEETING'), 10000, 'Timed-out waiting for remote user to connect to meeting');
      });

      it('starts screensharing', () => {
        browserFirefox.click('button[title="share screen"]');

        browserFirefox.waitUntil(() => (browserFirefox.getText('#screenshare-tracks') === 'SHARING'), 10000, 'Timed-out waiting for screenshare to start');
      });

      it('stops screensharing', () => {
        // Pausing for screenshare to establish because we don't currently have stream stats displayed
        browser.pause(2500);
        browserFirefox.click('button[title="stop screen share"]');
        browserFirefox.waitUntil(() => (browserFirefox.getText('#screenshare-tracks') === 'STOPPED'), 10000, 'Timed-out waiting for screenshare to stop');
      });

      it('starts screensharing remote', () => {
        browserChrome.click('button[title="share screen"]');

        browserChrome.waitUntil(() => (browserChrome.getText('#screenshare-tracks') === 'SHARING'), 10000, 'Timed-out waiting for screenshare to start');
      });

      flaky(it, process.env.SKIP_FLAKY_TESTS)('stops screensharing remote', () => {
        // Pausing for screenshare to establish because we don't currently have stream stats displayed
        browser.pause(2500);
        browserChrome.click('button[title="stop screen share"]');
        browserChrome.waitUntil(() => (browserChrome.getText('#screenshare-tracks') === 'STOPPED'), 10000, 'Timed-out waiting for screenshare to stop');
      });

      it('ends the call', () => {
        browserFirefox.click('[title="hangup"]');
        browserFirefox.waitUntil(() => (browserFirefox.getText('#call-status-local') === 'NOT_IN_MEETING'), 10000, 'Timed-out waiting for local user to disconnect from meeting');
      });
    });
  });
});
