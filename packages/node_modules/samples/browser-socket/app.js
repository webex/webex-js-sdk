/* eslint-env browser */

/* global ciscospark */

/* eslint-disable camelcase */
/* eslint-disable max-nested-callbacks */
/* eslint-disable no-alert */
/* eslint-disable no-console */
/* eslint-disable require-jsdoc */

// Declare some globals that we'll need throughout.
let webex;

// Save fields in localStorage so we don't have to retype them
// every time we reload the page.
[
  'access-token'
].forEach((id) => {
  const el = document.getElementById(id);
  el.value = localStorage.getItem(id);
  el.addEventListener('change', (event) => {
    localStorage.setItem(id, event.target.value);
  });
});

// Connect to Webex Teams and listen for message events.
function authorize() {
  webex = ciscospark.init({
    config: {

    },
    credentials: {
      access_token: document.getElementById('access-token').value
    }
  });

  if (webex.canAuthorize) {
    return Promise.resolve(webex.canAuthorize);
  }

  return Promise.reject(webex.canAuthorize);
}

// Update the UI.
function updateStatus(authorized) {
  const status = document.getElementById('connection-status');
  if (authorized) {
    status.innerHTML = 'initialized';
    status.classList.remove('label-warning');
    status.classList.remove('label-error');
    status.classList.add('label-success');
    document.getElementById('connect').disabled = true;
  }
  else {
    status.innerHTML = 'unauthorized';
    status.classList.remove('label-warning');
    status.classList.add('label-error');
  }
}

document.getElementById('credentials').addEventListener('submit', (event) => {
  // Don't reload the page when we submit the form.
  event.preventDefault();

  authorize()
    .then(() => {
      webex.messages.listen()
        .then(() => {
          console.log('connected');
          console.log('listening to messages');
          updateStatus(true);
          webex.messages.on('messages:created', (message) => {
            console.log('messages:created');
            console.info(message);
          });
        })
        .catch((err) => {
          console.error(`error listening to messages: ${err}`);
          updateStatus(false);
        });
    })
    .catch((err) => {
      console.error(`cannot authorize: ${err}`);
    });
});
